<?php 

	/**
	 * 
	 */
	class controller_posts extends controller_controller
	{
		
		function __construct()
		{
			parent::__construct();
		}

		public function test()
		{
			echo "calling from controller posts <br>";
		}

		/**
		 * getters
		 */

		public function getall()
		{
			$this->db->query("SELECT * FROM ((malwares INNER JOIN users ON malwares.user = users.id_user) INNER JOIN categories ON malwares.category = categories.id_categ) ORDER BY malwares.id_malware DESC");

			return $this->db->resultSet();
		}

		public function getbycateg($categ)
		{
			$this->db->query("SELECT * FROM ((malwares INNER JOIN users ON malwares.user = users.id_user) INNER JOIN categories ON malwares.category = categories.id_categ) WHERE malwares.category = :categ ORDER BY malwares.id_malware DESC");
			$this->db->bind(":categ", strip_tags($categ));

			return $this->db->resultSet();
		}

		public function getbycateguser($categ, $user)
		{
			$this->db->query("SELECT * FROM ((malwares INNER JOIN users ON malwares.user = users.id_user) INNER JOIN categories ON malwares.category = categories.id_categ) WHERE malwares.category = :categ AND malwares.user = :user ORDER BY malwares.id_malware DESC");
			$this->db->bind(":categ", strip_tags($categ));
			$this->db->bind(":user", strip_tags($user));

			return $this->db->resultSet();
		}

		public function getbyuser($id_user)
		{
			$this->db->query("SELECT * FROM ((malwares INNER JOIN users ON malwares.user = users.id_user) INNER JOIN categories ON malwares.category = categories.id_categ) WHERE malwares.user = :id ORDER BY malwares.id_malware DESC");
			$this->db->bind(":id", strip_tags($id_user));

			return $this->db->resultSet();

		}

		/**
		 * setters
		 */

		public function addnew()
		{
			if (isset($_FILES['upload'])) {
				$tmpFilePath = $_FILES['upload']['tmp_name'];
			    if ($tmpFilePath != ""){
				    // check if file already exists
			    	$hash = hash_file('md5', $tmpFilePath);
			    	$this->db->query("SELECT id_malware FROM malwares WHERE file_hash = :hash");
			    	$this->db->bind(":hash", $hash);

			    	$check = $this->db->single();
			    	if ($check) {
			    		echo 'file already exists'; 

			    		return false;
			    	}

				    $ext = explode('.', $_FILES['upload']['name']);
				    $finalext = strtolower(end($ext));
				    // checking if its a python file
				    if ($finalext !== "py") {
				    	echo "not python file";
				    	return false;
				    }
				    // checking file double extension attack
				    if(count($ext)>2){
				    	if(strtolower($ext[count($ext)-2]) === 'php'){
				    		echo "double extension";
				    		return false;
				    	}
				    }
				    $filename = uniqid('',true).".".$finalext;
				    $newFilePath = "files/".$filename;
				    if(move_uploaded_file($tmpFilePath, $newFilePath)){

				    	echo "file moved";

				    	// insert into database
				    	$this->db->query("INSERT INTO malwares (category, user, name_malware, threat_lvl, description, filename, file_hash) VALUES(:categ, :user, :name, :lvl, :descr, :filename, :hash)");
				    	$this->db->bind(":categ", strip_tags($_POST['categ']));
				    	$this->db->bind(":user", $_SESSION['user']);
				    	$this->db->bind(":name", strip_tags($_POST['malwarename']));
				    	$this->db->bind(":lvl", strip_tags($_POST['threatlvl']));
				    	$this->db->bind(":descr", strip_tags($_POST['description']));
				    	$this->db->bind(":filename", $filename);
				    	$this->db->bind(":hash", hash_file('md5', $newFilePath));

				    	try {
				    		$this->db->execute();
				    		return true;
				    	} catch (Exception $e) {
				    		echo $e;
				    		return false;
				    	}
				    }		    
				}
			}
			return false;
		}

		public function delete($id)
		{
			// checking if he s the owner
			$this->db->query("SELECT id_malware FROM malwares WHERE id_malware = :id AND user = :user");
			$this->db->bind(":id", $id);
			$this->db->bind(":user", $_SESSION['user']);

			$data = $this->db->single();
			if (!$data) {
				// not the owner
				return "error";
			}

			// he s the owner 

			// delete file

			$this->db->query("SELECT filename FROM malwares WHERE id_malware = :id");
			$this->db->bind(":id", $id);
			$data = $this->db->single();

			if (!unlink("files/".$data->filename)) {
				// file not deleted
				return "error";
			}

			// delete from db
			$this->db->query("DELETE FROM malwares WHERE id_malware = :id");
			$this->db->bind(":id", strip_tags($id));

			try {
				$this->db->execute();
				return "deleted";
			} catch (Exception $e) {
				echo $e;
				return "error";
			}

		}

	}

 ?>