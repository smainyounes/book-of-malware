<?php 

	/**
	 * 
	 */
	class controller_user extends controller_controller
	{
		
		function __construct()
		{
			parent::__construct();
		}

		public function test()
		{
			echo "calling from controller user <br>";
		}

		/**
		 *  getters
		 */

		public function getuserinfo($id)
		{
			$this->db->query("SELECT * FROM users WHERE id_user = :id");
			$this->db->bind(":id", strip_tags($id));

			try {
				return $this->db->single();
			} catch (Exception $e) {
				die($e);
			}
		}

		public function getconnectedinfo()
		{
			$this->db->query("SELECT * FROM users WHERE id_user = :id");
			$this->db->bind(":id", $_SESSION['user']);

			try {
				return $this->db->single();
			} catch (Exception $e) {
				die($e);
			}
		}

		public function login()
		{
			$this->db->query("SELECT * FROM users WHERE username = :username OR email = :email");
			$this->db->bind(":username", strip_tags($_POST['username']));
			$this->db->bind(":email", strip_tags($_POST['username']));

			try {
				$res = $this->db->single();	
			} catch (Exception $e) {
				die($e);
			}

			if (password_verify(strip_tags($_POST['pass']), $res->password)) {
				$_SESSION['user'] = $res->id_user;
				return true;
			}else{
				return false;
			}

		}

		/**
		 *  Setters
		 */

		public function changepassword($old, $new1, $new2)
		{
			if ($new1 === $new2) {
				// getting original password
				$this->db->query("SELECT password FROM users WHERE id_user = :id");
				$this->db->bind(":id", $_SESSION['user']);

				$pass = $this->db->single();
				if (password_verify($old, $pass->password)) {
					// password matches
					// changing password
					$this->db->query("UPDATE users SET password = :pass WHERE id_user = :id");
					$this->db->bind(":pass",password_hash(strip_tags($new1), PASSWORD_BCRYPT));
					$this->db->bind(":id", $_SESSION['user']);

					try {
						$this->db->execute();
						return true;
					} catch (Exception $e) {
						echo $e;
						return false;
					}

				}else{
					return false;
				}

			}else{
				return false;
			}
			
		}

		public function changepic()
		{
			# code...
		}

		public function signup()
		{
			if ($_POST['pass1'] === $_POST['pass2']) {
				$this->db->query("INSERT INTO users(username, email, nom, prenom, password, img) VALUES(:username, :email, :nom, :prenom, :pass, :img)");
				$this->db->bind(":username",strip_tags($_POST['username']));
				$this->db->bind(":email",strip_tags($_POST['email']));
				$this->db->bind(":nom",strip_tags($_POST['nom']));
				$this->db->bind(":prenom",strip_tags($_POST['prenom']));
				$this->db->bind(":pass",password_hash(strip_tags($_POST['pass1']), PASSWORD_BCRYPT));
				$this->db->bind(":img","a.jpg");

				try {
					$this->db->execute();
					return true;
				} catch (Exception $e) {
					echo $e;
					return false;
				}

			}else{
				return false;
			}

		}

		public function logout()
		{
			// remove all session variables
			session_unset(); 

			// destroy the session
			session_destroy(); 

		}

		public function exists($id)
		{
			$this->db->query("SELECT id_user FROM users WHERE id_user = :id");
			$this->db->bind(":id", $id);

			$res = $this->db->single();
			if ($res) {
				return true;
			}else{
				return false;
			}

		}

	}

 ?>