<?php 

	/**
	 * 
	 */
	class view_profile
	{
		
		private $post;
		private $category;
		private $user;

		function __construct()
		{
			$this->post = new controller_posts();
			$this->category = new controller_category();
			$this->user = new controller_user();
		}

		public function test()
		{
			echo "calling profile view <br>";
		}

		public function loadpage($msg = NULL)
		{

			$list_categ = $this->category->getall();

			if (isset($_GET['id'])) {
				//check if connected
				if (isset($_SESSION['user'])) {
					if ($_SESSION['user'] == $_GET['id']) {
						// load own profile
						$userinfo = $this->user->getconnectedinfo();
						if (isset($_GET['categ'])) {
							$posts = $this->post->getbycateguser($_GET['categ'],$_SESSION['user']);
						}else{
							$posts = $this->post->getbyuser($_SESSION['user']);
						}
					}else{
						// load from get
						$userinfo = $this->user->getuserinfo($_GET['id']);
						if (isset($_GET['categ'])) {
							$posts = $this->post->getbycateguser($_GET['categ'],$_GET['id']);
						}else{
							$posts = $this->post->getbyuser($_GET['id']);
						}
					}
				}else{
					// load from get
					$userinfo = $this->user->getuserinfo($_GET['id']);
					if (isset($_GET['categ'])) {
						$posts = $this->post->getbycateguser($_GET['categ'], $_GET['id']);
					}else{
						$posts = $this->post->getbyuser($_GET['id']);
					}
				}

			}else{
				// load own profile
				$userinfo = $this->user->getconnectedinfo();
				if (isset($_GET['categ'])) {
					$posts = $this->post->getbycateguser($_GET['categ'],$_SESSION['user']);
				}else{
					$posts = $this->post->getbyuser($_SESSION['user']);
				}
			}

			
			
			?>

			<div class="container" id="page-content">
				<?php if(isset($_GET['msg'])): ?>
					<div class="alert alert-dark alert-dismissible fade show" role="alert">
					  <strong>Success</strong> your malware has been posted 3:)  
					  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
					    <span aria-hidden="true">&times;</span>
					  </button>
					</div>
				<?php endif; ?>
				<?php if(isset($msg)): ?>
					<?php if($msg === "deleted"): ?>
						<div class="alert alert-dark alert-dismissible fade show" role="alert">
						  <strong>Success</strong> your malware was deleted  
						  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
						    <span aria-hidden="true">&times;</span>
						  </button>
						</div>
					<?php else: ?>
						<div class="alert alert-dark alert-dismissible fade show" role="alert">
						  <strong>Error</strong> Could not delete your malware  
						  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
						    <span aria-hidden="true">&times;</span>
						  </button>
						</div>
					<?php endif; ?>
				<?php endif; ?>
			  <div class="container-fluid text-center p-3">
			    <img src="img/<?php echo($userinfo->img) ?>" class="rounded-circle" width="250px" height="250px">
			    <div class="h3 text-white"><?php echo $userinfo->username; ?></div>
			  </div>
			  	<div class="row mb-lg-3 mb-sm-0">

			  	    <?php if(isset($_GET["id"])): ?>
			  	    	<a href="profile.php?id=<?php echo($_GET['id']) ?>" class="col-lg-3 col-sm-6 py-2">
			  	    	  <div class="card card-malware bg-secondary">
			  	    	    <div class="card-body">
			  	    	      <h5 class="card-title text-center text-white">All</h5>
			  	    	    </div>
			  	    	  </div>
			  	    	</a>
			  	    	<?php foreach($list_categ as $categ): ?>
			  	    		<a href="profile.php?categ=<?php echo($categ->id_categ.'&id='.$_GET['id']) ?>" class="col-lg-3 col-sm-6 py-2">
			  	    		  <div class="card card-malware bg-secondary">
			  	    		    <div class="card-body">
			  	    		      <h5 class="card-title text-center text-white"><?php echo $categ->nom_categ; ?></h5>
			  	    		    </div>
			  	    		  </div>
			  	    		</a>
			  	    	<?php endforeach; ?>
			  	    <?php else: ?>
			  	    	<a href="profile.php" class="col-lg-3 col-sm-6 py-2">
			  	    	  <div class="card card-malware bg-secondary">
			  	    	    <div class="card-body">
			  	    	      <h5 class="card-title text-center text-white">All</h5>
			  	    	    </div>
			  	    	  </div>
			  	    	</a>
			  	    	<?php foreach($list_categ as $categ): ?>
			  	    		<a href="profile.php?categ=<?php echo($categ->id_categ) ?>" class="col-lg-3 col-sm-6 py-2">
			  	    		  <div class="card card-malware bg-secondary">
			  	    		    <div class="card-body">
			  	    		      <h5 class="card-title text-center text-white"><?php echo $categ->nom_categ; ?></h5>
			  	    		    </div>
			  	    		  </div>
			  	    		</a>
			  	    	<?php endforeach; ?>
			  	    <?php endif; ?>

			  	</div>
			  	<?php if($posts): ?>
			  		<?php if(isset($_GET['id'])): ?>
			  			<table class="table table-striped table-dark">
			  			    <thead>
			  			      <tr>
			  			        <th scope="col">Name</th>
			  			        <th scope="col">Category</th>
			  			        <th scope="col">Threat</th>
			  			        <th scope="col">Description</th>
			  			        <th scope="col">Time</th>
			  			        <th scope="col">Download</th>
			  			      </tr>
			  			    </thead>
			  			    <tbody>
			  			      					      
			  			<?php foreach($posts as $mal): ?>
			  				<tr>
			  				  <th scope="row"><?php echo $mal->name_malware; ?></th>
			  				  <td><?php echo $mal->nom_categ; ?></td>
			  				  <td><?php echo $mal->threat_lvl; ?></td>
			  				  <td><?php echo $mal->description; ?></td>
			  				  <td><?php echo $mal->date_insert; ?></td>
			  				  <td><a href="files/<?php echo($mal->filename) ?>" download><?php echo $mal->filename; ?></a></td>
			  				</tr>
			  			<?php endforeach; ?>
			  			    </tbody>
			  			</table>
			  		<?php else: ?>
			  			<table class="table table-striped table-dark">
			  			    <thead>
			  			      <tr>
			  			        <th scope="col">Name</th>
			  			        <th scope="col">Category</th>
			  			        <th scope="col">Threat</th>
			  			        <th scope="col">Description</th>
			  			        <th scope="col">Time</th>
			  			        <th scope="col">Download</th>
			  			        <th scope="col">Delete</th>
			  			      </tr>
			  			    </thead>
			  			    <tbody>
			  			      					      
			  			<?php foreach($posts as $mal): ?>
			  				<tr>
			  				  <th scope="row"><?php echo $mal->name_malware; ?></th>
			  				  <td><?php echo $mal->nom_categ; ?></td>
			  				  <td><?php echo $mal->threat_lvl; ?></td>
			  				  <td><?php echo $mal->description; ?></td>
			  				  <td><?php echo $mal->date_insert; ?></td>
			  				  <td><a href="files/<?php echo($mal->filename) ?>" download><?php echo $mal->filename; ?></a></td>
			  				  <td>
			  				  	<button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#exampleModalCenter" data-id="<?php echo($mal->id_malware) ?>">Delete</button>
			  				  </td>
			  				</tr>
			  			<?php endforeach; ?>
			  			    </tbody>
			  			</table>
			  		<?php endif; ?>
			  	<?php else: ?>
			  		<div class="h2 text-center text-white">No malware posted yet</div>
			  	<?php endif; ?>
			        
			</div>
			<?php if(isset($_GET['id'])): ?>
				<!-- Modal -->
				<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
				  <div class="modal-dialog modal-dialog-centered" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalCenterTitle">Confirmation</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body">
				        Are you sure u want to delete this malware?
				      </div>
				      <div class="modal-footer">
				      	<form method="POST">
				      		<input id="valll" type="text" name="id" hidden>
				      		<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
				      		<button type="submit" type="button" class="btn btn-primary" name="delete">Yes</button>
				      	</form>
				        
				      </div>
				    </div>
				  </div>
				</div>

				<script type="text/javascript">
					$('#exampleModalCenter').on('show.bs.modal', function (event) {
					  var button = $(event.relatedTarget) // Button that triggered the modal
					  var id = button.data('id') 
					  $('#valll').val(id);
					});
				</script>
			<?php endif; ?>
			

			<?php
		}
	}


 ?>